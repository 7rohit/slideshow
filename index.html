<html>
<head>
  <link href="https://sachinchoolur.github.io/lightgallery.js/lightgallery/css/lightgallery.css" rel="stylesheet">
  <link href="https://sachinchoolur.github.io/lightgallery.js/lightgallery/css/lg-transitions.css" rel="stylesheet">

  <script src="js/lightgallery.js"></script>

  <!-- lightgallery plugins -->
  <script src="https://sachinchoolur.github.io/lightgallery.js/lightgallery/js/lg-thumbnail.js"></script>
  <script src="https://sachinchoolur.github.io/lightgallery.js/lightgallery/js/lg-fullscreen.js"></script>
  <script src="js/lg-video.js"></script>
  <script src="https://sachinchoolur.github.io/lightgallery.js/lightgallery/js/lg-autoplay.js"></script>
  <script src="https://f.vimeocdn.com/js/froogaloop2.min.js"></script>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>

  <script src="https://solid.github.io/releases/rdflib.js/rdflib-0.7.0.min.js"></script>


  <meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no" />

</head>
<body>

  <div id="animated-thumbnails">
    <div id="vid"></div>
  </div>

  <script>

  // defaults
  var defaultContainer = 'https://melvin.databox.me/imagelist/'

  // globals
  var bg        = getParam('bg')
  var container = getParam('container') || defaultContainer
  var inbox     = getParam('inbox')
  var playlist  = getParam('playlist')
  var safe      = getParam('safe')
  var sort      = getParam('sort')
  var tag       = getParam('tag')
  var wss       = getParam('wss') || playlist || container

  var slides    = []
  var files     = []
  var el        = document.getElementById('animated-thumbnails')
  $scope        = {}
  var doRefresh = false
  var fetchURI

  // utils
  /**
   * Get parameters from query string
   * @param  {string} name Name of parameter
   * @return {String}      Value of parameter
   */
  function getParam(name) {
    name = name.replace(/[\[]/,"\\\[").replace(/[\]]/,"\\\]")
    var regexS = "[\\?&]"+name+"=([^&#]*)"
    var regex = new RegExp(regexS)
    var results = regex.exec(window.location.href)
    if( results == null ) {
      return ""
    } else {
      return decodeURIComponent(results[1])
    }
  }

  /**
   * getInbox
   * @return {string} inboxURI
   */
  function getInbox() {
    if (inbox) {
      return inbox
    }
    if (playlist) {
      var ret = playlist.substring(0, playlist.lastIndexOf('/')) + '/../inbox/'
      return ret
    }
    if (container) {
      var ret = container + '../inbox/'
      return ret
    }
  }

  /**
   * Get the value or uri from an object
   * @param  {object} g And rdflib graph object
   * @param  {string} s And rdflib subject
   * @param  {string} p Predicate as a string
   * @return {string}   The value of the object or null
   */
  function anyObj(g, s, p) {
    var obj
    obj = g.any(s, $rdf.sym(p))
    if (obj && obj.value) {
      return obj.value
    }
    if (obj && obj.uri) {
      return obj.uri
    }
  }

  /**
   * Change files into slides
   * @param  {array}  files  Array of files
   * @param  {arrty}  slides Array of slides
   */
  function filesToSlides(files, slides) {

    for (var i = 0; i < files.length; i++) {
      var file = files[i]
      if (/.mp4$/.test(file.uri)) {
        var thumb = file.uri.replace('/video/', '/thumbnail/') + '.png'
        var title = file.title || 'Playlist'
        var slide = {
          href: file.uri + '?' + new Date().getTime(),
          "thumb": thumb + '?' + new Date().getTime(),
          subHtml: '<span class="pl">' + title + '</span> item : <a href="#" onclick="play()">' + ( i + 1 ) + '</a>' ,
          videoAutoplay: false,
          vimeoPlayerParams: { autoplay: 0 },
          youtubePlayerParams: { autoplay: 0 },
          autoplay: false,
          autoplayControls: true,
          html: '<video class="lg-video-object lg-youtube lg-object" id="v' + i + '" controls> <source src="' + file.uri + '?' + new Date().getTime() + '" ></video>'
        }
      } else {
        var file  = files[i]
        var title = file.title || 'Playlist'
        var slide = {
          src: files[i].uri + '?' + new Date().getTime(),
          thumb: files[i].uri + '?' + new Date().getTime(),
          subHtml: '<span class="sl">' + title + ' item : ' + ( i + 1 ) + '</span>',
          videoAutoplay: false,
          vimeoPlayerParams: { autoplay: 0 },
          youtubePlayerParams: { autoplay: 0 },
          autoplay: false,
          autoplayControls: true
        }
      }
      slides.push(slide)
    }
  }

  /**
   * Creates a light gallery
   * @param  {object} el The element to use
   */
  function createGallery(el) {

    lightGallery(el, {

      thumbnail:true,
      dynamic: true,
      dynamicEl: slides,
      videoAutoplay: false,
      autoplay: false,
      autoplayControls: true

    })
    if (bg) {
      $('.lg-backdrop').css('background-color', bg)
    }

  }

  /**
  * Get wss from URI
  * @param  {String} uri The URI to use
  */
  function getWss(uri) {
    console.log('getting wss for ', uri)
    var ret = 'wss://' + uri.split('/')[2]
    return ret
  }

  /**
  * Get type of uri
  * @param  {string} str The uri
  * @return {number}     The type or -1
  */
  function getType(str) {
    var type = -1
    var match = /\/[0-9]+,[0-9]+,.*/.test(str)
    if (!match) {
      return -1
    }
    var a = str.split(',')
    if (a && a[1]) {
      type = parseInt(a[1])
    } else {
      return -1
    }
    if (isNaN(type)) {
      return -1
    }
    return type
  }

  /**
  * Connect to a web socket
  * @param  {String}  sub Where to subscribe to
  * @param  {boolean} quiet dont ping server
  */
  function connectToSocket(sub, quiet) {
    // Some servers time out after 5 minutes inactive
    var INTERVAL  = 240 * 1000
    var RECONNECT = 60 * 1000

    if ($scope.socket) return

    var socket

    console.log('connecting to : ' + sub)
    var wss = getWss(sub)
    console.log('connecting to : ' + wss)

    socket = new WebSocket(wss, 'echo-protocol')

    socket.onopen = function(){
      console.log('subscribing to',  sub)
      $scope.socket = socket
      socket.send('sub ' + sub, socket)

      if (!quiet) {
        setInterval(function() { socket.send('ping'); }, INTERVAL)
      }

    }

    socket.onerror = function(){
      console.log('socket error')
      setTimeout(connectToSocket, RECONNECT)
    }

    socket.onclose = function(){
      console.log('socket closed')
      setTimeout(connectToSocket, RECONNECT)
    }

    socket.onmessage = function(msg) {
      console.log('got pub from', msg)
      var a = msg.data.split(' ')
      if (a[0] !== 'pub') return
      processSocket(a[1])
    }

  }

  /**
  * Process message from socket
  * @param  {String} uri uri that has changed
  */
  function processSocket(uri) {
    console.log('got ping from', uri)
    refresh()
  }


  /**
  * creates slides
  * @return {[type]} [description]
  */
  function create() {

    fetchURI = playlist || container
    if (playlist) {
      fetchURI = playlist
      sort = sort || 'asc'
    } else {
      sort = sort || 'desc'
      fetchURI = container
    }

    var el = document.getElementById('animated-thumbnails')
    slides = []
    files = []
    g = $rdf.graph()
    f = $rdf.fetcher(g)

    f.requestURI(fetchURI , undefined, true, processGraph)

  }

  /**
  * Refresh slides
  */
  function refresh() {

    var isPlaying = false
    for (var i = 0; i < slides.length; i++) {
      var slide = slides[i]
      var id = 'v' + i
      var vid = document.getElementById(id)
      //console.log(id, vid)
      if (vid && ! vid.paused) {
        isPlaying = true
        doRefresh = true
        return
      }
    }

    var el = document.getElementById('animated-thumbnails')
    var slideshow = window.lgData[el.getAttribute('lg-uid')]
    if (slideshow) {
      slideshow.destroy(true)
    }

    var fetchURI = playlist || container
    slides = []
    files = []
    g = $rdf.graph()
    f = $rdf.fetcher(g)

    f.requestURI(fetchURI , undefined, true, processGraph)

  }

  /**
   * Process a graph and gets playlist material
   * @param  {number} ok   Return code
   * @param  {string} body Body of return
   */
  function processGraph(ok, body) {

    var arr = g.statementsMatching(null, $rdf.sym('http://www.w3.org/ns/ldp#contains'), null, $rdf.sym(fetchURI))
    console.log(arr)
    for (var i = 0; i < arr.length; i++) {
      var file = arr[i]
      var subject = file.subject
      if (file.object && file.object.uri && /.ttl$/.test(file.object.uri) ) {
        continue
      }
      var mtime = anyObj(g, file.object, 'http://www.w3.org/ns/posix/stat#mtime')
      var title = anyObj(g, file.object, 'http://purl.org/dc/terms/title')

      var type = getType(file.object.uri)
      files.push({ "uri" : file.object.uri, "mtime" : mtime, "type" : type, "title" : title })
    }
    files = files.sort(function(a,b) {
      if (a.type === b.type) {
        if (sort === 'desc') {
          return parseFloat(b.mtime) - parseFloat(a.mtime)
        } else {
          return parseFloat(a.mtime) - parseFloat(b.mtime)
        }
      } else {
        var order = [1,0,2]
        return order[b.type] - order[a.type]
      }
    })
    filesToSlides(files, slides)

    setTimeout(function() {

      createGallery(el)
      setTimeout(addEvents, 1000)

    }, 500)

  }

  /**
   * put a file with turtle data
   * @param  {string} file The URI to put
   * @param  {string} data The data to put in turtle
   */
  function putFile(file, data) {
    console.log(file, data)
    xhr = new XMLHttpRequest()
    xhr.open('PUT', file, false)
    xhr.setRequestHeader('Content-Type', 'text/turtle; charset=UTF-8')
    xhr.send(data)
  }

  function put(name, data) {
    putFile(inbox + name, data)
  }

  function getCurrentVideo(type) {
    for (var i = 0; i < slides.length; i++) {
      var slide = slides[i]
      var href = slide.href
      if (getType(href) === type) {
        return i
      }
    }
  }

  /**
   * Create turtle for inbox post
   * @param  {string} fetchURI The URI of the playlist
   * @param  {string} tag      A tag
   * @return {string}          Turtle to send
   */
  function toTurtle(fetchURI, tag) {
    var turtle = '<> <urn:string:playlist> <' + fetchURI + '> .\n'
    if (tag) {
      turtle += '<> <urn:string:tag> "' + tag + '" .\n'
    }
    var preds = g.statementsMatching(undefined, $rdf.sym("http://www.w3.org/2007/ont/httph#user"), null)
    if (preds && preds[0] && preds[0].object && preds[0].object.value) {
      user = preds[0].object.value
    }
    if (user) {
      turtle += '<> <urn:string:webid> <' + user + '> .\n'
    }
    if (safe) {
      turtle += '<> <urn:string:safe> <' + safe + '> .\n'
    }
    return turtle
  }

  /**
   * Play a video
   * @param  {number} type Type of function
   */
  function play(type) {
    if (type === undefined) {
      type = 1
    }
    doRefresh = false

    var i = getCurrentVideo(type)


    setTimeout(function() {
      var id = 'v' + i
      var el = document.getElementById(id)
      //console.log(i, id, el)

      if (el && el.play) {
        el.play()
        rfs =
        el.requestFullScreen
        || el.webkitRequestFullScreen
        || el.mozRequestFullScreen
        rfs.call(el)

        el.onended = function(e) {
          console.log(e)
          if (document.exitFullscreen) {
            document.exitFullscreen()
          } else if (document.msExitFullscreen) {
            document.msExitFullscreen()
          } else if (document.mozCancelFullScreen) {
            document.mozCancelFullScreen()
          } else if (document.webkitExitFullscreen) {
            document.webkitExitFullscreen()
          }
          if (doRefresh) {
            refresh()
          }
        }

      }

      var turtle = toTurtle(fetchURI, tag)
      if (inbox) {
        if (type === 1) {
          put(100, turtle)
        }
        if (type === 0) {
          put(111, turtle)
        }
        if (type === 2) {
          put(113, turtle)
        }
      }

    }, 700)

    var el = document.getElementById('animated-thumbnails')
    var slideshow = window.lgData[el.getAttribute('lg-uid')]
    if (slideshow) {
      slideshow.slide(i)
    }

  }

  /**
   * View a slide
   */
  function view() {
    doRefresh = false

    var i = 0


    setTimeout(function() {
      var id = 'v' + i
      var el = document.getElementById(id)
      //console.log(i, id, el)
      el = document.getElementsByTagName('img')[0]

      if (el) {
        rfs =
        el.requestFullScreen
        || el.webkitRequestFullScreen
        || el.mozRequestFullScreen
        rfs.call(el)

        setTimeout( function(e) {
          if (document.exitFullscreen) {
            document.exitFullscreen()
          } else if (document.msExitFullscreen) {
            document.msExitFullscreen()
          } else if (document.mozCancelFullScreen) {
            document.mozCancelFullScreen()
          } else if (document.webkitExitFullscreen) {
            document.webkitExitFullscreen()
          }
          if (doRefresh) {
            refresh()
          }
        }, 4000)

      }

      var turtle = toTurtle(fetchURI)
      if (inbox) {
        put('112', turtle)
      }

    }, 700)

    var el = document.getElementById('animated-thumbnails')
    var slideshow = window.lgData[el.getAttribute('lg-uid')]
    if (slideshow) {
      slideshow.slide(i)
    }

  }

  /**
   * Rate a slide
   * @param  {string} rating The rating file name
   */
  function rate(rating) {
    var turtle = toTurtle(fetchURI)
    if (inbox) {
      put(rating, turtle)
    }
  }

  /**
   * Add events to DOM
   */
  function addEvents() {
    var els = document.getElementsByClassName("lg-autoplay-button")
    console.log('els', els)
    for (var i = 0; i < els.length; i++) {
      var el = els[i]
      el.onclick = function() {
        play(0)
      }
    }

    var els = document.getElementsByClassName("pl")
    console.log('els', els)
    for (var i = 0; i < els.length; i++) {
      var el = els[i]
      el.onclick = function() {
        play(1)
      }
    }

    var els = document.getElementsByClassName("lg-image")
    for (var i = 0; i < els.length; i++) {
      var el = els[i]
      el.onclick = function() {
        view(12)
      }
      el.ontouchstart = function() {
        view(12)
      }
    }

    el = document.getElementById("lg-counter")
    console.log('el', el)
    el.onclick = function() {
      play(2)
    }

    if (bg) {
      $('.lg-backdrop').css('background-color', bg)
    }

  }

  /**
   * Startup functions
   */
  $(function() {
    setTimeout(function() {

      addEvents()
      if (bg) {
        $('.lg-backdrop').css('background-color', bg)
      }

    }, 2000)
  })

  // Add keystroke events
  document.addEventListener('keydown', function(e){

    console.log(e.keyCode)

    if(e.keyCode === 80 || e.keyCode === 45 ){
      play(1)

      e.preventDefault()
      return false
    }

    if(e.keyCode === 79 || e.keyCode === 46 ){
      play(0)

      e.preventDefault()
      return false
    }

    if(e.keyCode === 78 || e.keyCode === 13 ){
      play(2)

      e.preventDefault()
      return false
    }

    if(e.keyCode === 49 ){
      rate(1)

      e.preventDefault()
      return false
    }

    if(e.keyCode === 50 ){
      rate(2)

      e.preventDefault()
      return false
    }

    if(e.keyCode === 51 ){
      rate(3)

      e.preventDefault()
      return false
    }

    if(e.keyCode === 52 ){
      rate(4)

      e.preventDefault()
      return false
    }

    if(e.keyCode === 53 ){
      rate(5)

      e.preventDefault()
      return false
    }

    if(e.keyCode === 54 ){
      rate(6)

      e.preventDefault()
      return false
    }

    if(e.keyCode === 55 ){
      rate(7)

      e.preventDefault()
      return false
    }

    if(e.keyCode === 56 ){
      rate(8)

      e.preventDefault()
      return false
    }

    if(e.keyCode === 57 ){
      rate(9)

      e.preventDefault()
      return false
    }

    if(e.keyCode === 48 ){
      rate(10)

      e.preventDefault()
      return false
    }

    if(e.keyCode === 187   ){
      view(12)

      e.preventDefault()
      return false
    }

  })

  //main
  inbox = inbox || getInbox()
  console.log('inbox', inbox)
  connectToSocket(wss)
  create()


  </script>
</body>
<html>
