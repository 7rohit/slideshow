<html>
<head>
  <link href="https://sachinchoolur.github.io/lightgallery.js/lightgallery/css/lightgallery.css" rel="stylesheet">
  <link href="https://sachinchoolur.github.io/lightgallery.js/lightgallery/css/lg-transitions.css" rel="stylesheet">

  <script src="https://sachinchoolur.github.io/lightgallery.js/lightgallery/js/lightgallery.js"></script>

  <!-- lightgallery plugins -->
  <script src="https://sachinchoolur.github.io/lightgallery.js/lightgallery/js/lg-thumbnail.js"></script>
  <script src="https://sachinchoolur.github.io/lightgallery.js/lightgallery/js/lg-fullscreen.js"></script>
  <script src="js/lg-video.js"></script>
  <script src="https://sachinchoolur.github.io/lightgallery.js/lightgallery/js/lg-autoplay.js"></script>
  <script src="https://f.vimeocdn.com/js/froogaloop2.min.js"></script>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>

  <script src="https://solid.github.io/releases/rdflib.js/rdflib-0.7.0.min.js"></script>


</head>
<body>

  <div id="animated-thumbnails">
  </div>

<script>

//var solid = SolidClient

// utils
function getParam(name) {
  name = name.replace(/[\[]/,"\\\[").replace(/[\]]/,"\\\]");
  var regexS = "[\\?&]"+name+"=([^&#]*)";
  var regex = new RegExp(regexS);
  var results = regex.exec(window.location.href);
  if( results == null ) {
    return "";
  } else {
    return decodeURIComponent(results[1]);
  }
}

/**
 * Get the value or uri from an object
 * @param  {object} g And rdflib graph object
 * @param  {string} s And rdflib subject
 * @param  {string} p Predicate as a string
 * @return {string}   The value of the object or null
 */
function anyObj(g, s, p) {
  var obj
  obj = g.any(s, $rdf.sym(p))
  if (obj && obj.value) {
    return obj.value
  }
  if (obj && obj.uri) {
    return obj.uri
  }
}


// defaults
var defaultContainer = 'https://melvin.databox.me/imagelist/'
var defaultSort      = 'asc'

// globals
var container = getParam('container') || defaultContainer
var playlist  = getParam('playlist')
var sort      = getParam('sort')      || defaultSort
var tag       = getParam('tag')
var wss       = getParam('wss')       || container

var slides    = []
var files     = []
var el        = document.getElementById('animated-thumbnails')

function create() {

  for (var i = 0; i < files.length; i++) {
    var file  = files[i]
    var title = file.title || 'Playlist'
    var slide = {
      src: files[i].uri + '?' + new Date().getTime(),
      thumb: files[i].uri + '?' + new Date().getTime(),
      subHtml: '' + title + ' item : ' + ( i + 1 ),
      videoAutoplay: false,
      vimeoPlayerParams: { autoplay: 0 },
      youtubePlayerParams: { autoplay: 0 },
      autoplay: false,
      autoplayControls: true

    }
    slides.push(slide)
  }


  lightGallery(el, {
      thumbnail:true,

      dynamic: true,
      dynamicEl: slides,
      videoAutoplay: false,
      autoplay: false,
      autoplayControls: true

  })

}

function refresh() {

  var el = document.getElementById('animated-thumbnails');
  window.lgData[el.getAttribute('lg-uid')].destroy(true)

  setTimeout(function() {
    var slides = []
    for (var i = 0; i < files.length; i++) {
      var slide = {
        src: files[i].uri + '?' + new Date().getTime(),
        thumb: files[i].uri + '?' + new Date().getTime(),
        subHtml: 'An image number ' + i,
        videoAutoplay: false,
        autoplay: false,
        autoplayControls: true
      }
      slides.push(slide)
    }


    lightGallery(document.getElementById('animated-thumbnails'), {
        thumbnail:true,

        dynamic: true,
        dynamicEl: slides,
        videoAutoplay: false,
        vimeoPlayerParams: { autoplay: 0 },
        youtubePlayerParams: { autoplay: 0 },
        autoplay: false,
        autoplayControls: true

    })

  }, 500)


}


//window.lgData[0].slide(2);


$scope = {}

/**
 * Get wss from URI
 * @param  {String} uri The URI to use
 */
function getWss(uri) {
  var ret = 'wss://' + uri.split('/')[2]
  return ret
}


/**
 * Connect to a web socket
 * @param  {String}  sub Where to subscribe to
 * @param  {boolean} quiet dont ping server
 */
function connectToSocket(sub, quiet) {
  // Some servers time out after 5 minutes inactive
  var INTERVAL  = 240 * 1000;
  var RECONNECT = 60 * 1000;

  if ($scope.socket) return;

  var socket;

  console.log('connecting to : ' + sub);
  var wss = getWss(sub);
  console.log('connecting to : ' + wss);

  socket = new WebSocket(wss);

  socket.onopen = function(){
    console.log(sub);
    $scope.socket = socket;
    socket.send('sub ' + sub, socket);

    if (!quiet) {
      setInterval(function() { socket.send('ping'); }, INTERVAL);
    }

  };

  socket.onerror = function(){
    console.log('socket error');
    setTimeout(connectToSocket, RECONNECT);
  };

  socket.onclose = function(){
    console.log('socket closed');
    setTimeout(connectToSocket, RECONNECT);
  };

  socket.onmessage = function(msg) {
    var a = msg.data.split(' ');
    if (a[0] !== 'pub') return;
    processSocket(a[1]);
  };

}

/**
 * Process message from socket
 * @param  {String} uri uri that has changed
 */
function processSocket(uri) {
  console.log(uri);
  refresh()
}

connectToSocket(wss)




console.log('loading container', container)
g = $rdf.graph();
f = $rdf.fetcher(g);

var fetchURI = playlist || container

if (playlist) {

  f.requestURI(fetchURI , undefined, true, function(ok, body) {
    var arr = g.statementsMatching(null, $rdf.sym('http://www.w3.org/ns/ldp#contains'), null, $rdf.sym(fetchURI))
    console.log(arr)
    for (var i = 0; i < arr.length; i++) {
      var file = arr[i]
      var object = file.object
      var subject = file.subject
      if (!playlist && subject && subject.uri && /.ttl$/.test(subject.uri) ) {
        continue
      }
      var mtime = anyObj(g, file.object, 'http://www.w3.org/ns/posix/stat#mtime')
      var title = anyObj(g, file.object, 'http://purl.org/dc/terms/title')
      var o = { "uri" : file.object.uri, "mtime" : mtime, "title" : title }
      console.log(o)

      files.push(o)

    }
    files = files.sort(function(a,b) {
      if (sort === 'asc') {
        return parseFloat(a.mtime) - parseFloat(b.mtime)
      } else {
        return parseFloat(b.mtime) - parseFloat(a.mtime)
      }
    })
    create()

  })

} else {

  f.nowOrWhenFetched( container , undefined, function(ok, body) {
    var arr = g.statementsMatching(null, $rdf.sym('http://www.w3.org/ns/ldp#contains'), null, $rdf.sym(container))
    console.log(arr)
    for (var i = 0; i < arr.length; i++) {
      var file = arr[i]
      files.push({ "uri": file.object.uri })
    }
    create()

  })

}



</script>
</body>
<html>
