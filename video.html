<html>
<head>
  <link href="https://sachinchoolur.github.io/lightgallery.js/lightgallery/css/lightgallery.css" rel="stylesheet">
  <link href="https://sachinchoolur.github.io/lightgallery.js/lightgallery/css/lg-transitions.css" rel="stylesheet">

  <script src="js/lightgallery.js"></script>

  <!-- lightgallery plugins -->
  <script src="https://sachinchoolur.github.io/lightgallery.js/lightgallery/js/lg-thumbnail.js"></script>
  <script src="https://sachinchoolur.github.io/lightgallery.js/lightgallery/js/lg-fullscreen.js"></script>
  <script src="js/lg-video.js"></script>
  <script src="https://sachinchoolur.github.io/lightgallery.js/lightgallery/js/lg-autoplay.js"></script>
  <script src="https://f.vimeocdn.com/js/froogaloop2.min.js"></script>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>

  <script src="https://solid.github.io/releases/rdflib.js/rdflib-0.7.0.min.js"></script>


</head>
<body>

  <div id="animated-thumbnails">
    <div id="vid"></div>
  </div>

  <script>

  //var solid = SolidClient

  // utils
  function getParam(name) {
    name = name.replace(/[\[]/,"\\\[").replace(/[\]]/,"\\\]");
    var regexS = "[\\?&]"+name+"=([^&#]*)";
    var regex = new RegExp(regexS);
    var results = regex.exec(window.location.href);
    if( results == null ) {
      return "";
    } else {
      return decodeURIComponent(results[1]);
    }
  }

  // globals
  var container = getParam('container') || 'https://melvin.databox.me/imagelist/'
  var wss = getParam('wss') || container
  var playlist = getParam('playlist')

  var slides = []
  var el = document.getElementById('animated-thumbnails')
  var files = []



  function filesToSlides(files, slides) {

    for (var i = 0; i < files.length; i++) {
      var file = files[i]
      var thumb = file.uri.replace('/video/', '/thumbnail/') + '.png'
      var slide = {
        href: file.uri + '?' + new Date().getTime(),
        "thumb": thumb + '?' + new Date().getTime(),
        subHtml: '<span class="pl">Playlist</span> item : <a href="#" onclick="play()">' + ( i + 1 ) + '</a>' ,
        videoAutoplay: false,
        vimeoPlayerParams: { autoplay: 0 },
        youtubePlayerParams: { autoplay: 0 },
        autoplay: false,
        autoplayControls: true,
        html: '<video class="lg-video-object lg-youtube lg-object" id="v' + i + '" controls> <source src="' + file.uri + '?' + new Date().getTime() + '" ></video>'

      }
      slides.push(slide)
    }

  }


  function createGallery(el) {

    lightGallery(el, {
      thumbnail:true,

      dynamic: true,
      dynamicEl: slides,
      videoAutoplay: false,
      autoplay: false,
      autoplayControls: true

    })

  }

  $scope = {}

  /**
  * Get wss from URI
  * @param  {String} uri The URI to use
  */
  function getWss(uri) {
    console.log('getting wss for ', uri)
    var ret = 'wss://' + uri.split('/')[2]
    return ret
  }

  /**
  * Get type of uri
  * @param  {string} str The uri
  * @return {number}     The type or -1
  */
  function getType(str) {
    var type = -1
    var match = /\/[0-9]+,[0-9]+,.*/.test(str)
    if (!match) {
      return -1
    }
    var a = str.split(',')
    if (a && a[1]) {
      type = parseInt(a[1])
    } else {
      return -1
    }
    if (isNaN(type)) {
      return -1
    }
    return type
  }

  /**
  * Connect to a web socket
  * @param  {String}  sub Where to subscribe to
  * @param  {boolean} quiet dont ping server
  */
  function connectToSocket(sub, quiet) {
    // Some servers time out after 5 minutes inactive
    var INTERVAL  = 240 * 1000;
    var RECONNECT = 60 * 1000;

    if ($scope.socket) return;

    var socket;

    console.log('connecting to : ' + sub);
    var wss = getWss(sub);
    console.log('connecting to : ' + wss);

    socket = new WebSocket(wss);

    socket.onopen = function(){
      console.log('subscribing to',  sub);
      $scope.socket = socket;
      socket.send('sub ' + sub, socket);

      if (!quiet) {
        setInterval(function() { socket.send('ping'); }, INTERVAL);
      }

    };

    socket.onerror = function(){
      console.log('socket error');
      setTimeout(connectToSocket, RECONNECT);
    };

    socket.onclose = function(){
      console.log('socket closed');
      setTimeout(connectToSocket, RECONNECT);
    };

    socket.onmessage = function(msg) {
      console.log('got pub from', msg);
      var a = msg.data.split(' ');
      if (a[0] !== 'pub') return;
      processSocket(a[1]);
    };

  }

  /**
  * Process message from socket
  * @param  {String} uri uri that has changed
  */
  function processSocket(uri) {
    console.log('got ping from', uri);
    refresh()
  }

  connectToSocket(wss)



  /**
  * creates slides
  * @return {[type]} [description]
  */
  function create() {

    var fetchURI = playlist || container

    var el = document.getElementById('animated-thumbnails');
    slides = []
    files = []
    g = $rdf.graph();
    f = $rdf.fetcher(g);

    f.requestURI(fetchURI , undefined, true, function(ok, body) {
      var arr = g.statementsMatching(null, $rdf.sym('http://www.w3.org/ns/ldp#contains'), null, $rdf.sym(fetchURI))
      console.log(arr)
      for (var i = 0; i < arr.length; i++) {
        var file = arr[i]
        var subject = file.subject
        var mtime = g.any(file.object, $rdf.sym("http://www.w3.org/ns/posix/stat#mtime"))
        console.log(mtime.value)
        var type = getType(file.object.uri)
        files.push({ "uri" : file.object.uri, "mtime" : mtime.value, "type" : type })
      }
      files = files.sort(function(a,b) {
        if (a.type === b.type) {
          return parseFloat(b.mtime) - parseFloat(a.mtime)
        } else {
          var order = [1,0,2]
          return order[a.type] - order[b.type]
        }
      })
      filesToSlides(files, slides)

      createGallery(el)

    })

  }

  //main
  var doRefresh = false
  create()

  /**
  * Refresh slides
  */
  function refresh() {

    var isPlaying = false
    for (var i = 0; i < slides.length; i++) {
      var slide = slides[i]
      var id = 'v' + i
      var vid = document.getElementById(id)
      console.log(id, vid)
      if (vid && ! vid.paused) {
        isPlaying = true
        doRefresh = true
        return
      }
    }

    var el = document.getElementById('animated-thumbnails');
    window.lgData[el.getAttribute('lg-uid')].destroy(true)

    var fetchURI = playlist || container
    slides = []
    files = []
    g = $rdf.graph();
    f = $rdf.fetcher(g);


    f.requestURI(fetchURI , undefined, true, function(ok, body) {
      var arr = g.statementsMatching(null, $rdf.sym('http://www.w3.org/ns/ldp#contains'), null, $rdf.sym(fetchURI))
      console.log(arr)
      for (var i = 0; i < arr.length; i++) {
        var file = arr[i]
        var subject = file.subject
        var mtime = g.any(file.object, $rdf.sym("http://www.w3.org/ns/posix/stat#mtime"))
        console.log(mtime.value)
        var type = getType(file.object.uri)
        files.push({ "uri" : file.object.uri, "mtime" : mtime.value, "type" : type })
      }
      files = files.sort(function(a,b) {
        if (a.type === b.type) {
          return parseFloat(b.mtime) - parseFloat(a.mtime)
        } else {
          var order = [1,0,2]
          return order[a.type] - order[b.type]
        }
      })
      filesToSlides(files, slides)


      setTimeout(function() {


        createGallery(el)
        setTimeout(addEvents, 1000)

      }, 500)


    })



    //location.reload()

  }


  function putFile(file, data) {
    xhr = new XMLHttpRequest();
    xhr.open('PUT', file, false);
    xhr.setRequestHeader('Content-Type', 'text/turtle; charset=UTF-8');
    xhr.send(data);
  }

  var hook = getParam('hook')

  function put(name) {
    putFile(hook + name, '')
  }

  function getCurrentVideo(type) {
    for (var i = 0; i < slides.length; i++) {
      var slide = slides[i]
      var href = slide.href
      if (getType(href) === type) {
        return i
      }
    }
  }


  function play(type) {
    if (type === undefined) {
      type = 1
    }
    doRefresh = false

    var i = getCurrentVideo(type)



    var el = document.getElementById('animated-thumbnails');
    window.lgData[el.getAttribute('lg-uid')].slide(i)

    setTimeout(function() {
      var id = 'v' + i
      var el = document.getElementById(id)
      console.log(i, id, el)

      el.play()
      rfs =
      el.requestFullScreen
      || el.webkitRequestFullScreen
      || el.mozRequestFullScreen
      rfs.call(el);

      if (hook) {
        if (type === 1) {
          put(100)
        }
        if (type === 0) {
          put(111)
        }
        if (type === 2) {
          put(113)
        }
      }


      el.onended = function(e) {
        console.log(e)
        if (document.exitFullscreen) {
          document.exitFullscreen();
        } else if (document.msExitFullscreen) {
          document.msExitFullscreen();
        } else if (document.mozCancelFullScreen) {
          document.mozCancelFullScreen();
        } else if (document.webkitExitFullscreen) {
          document.webkitExitFullscreen();
        }
        if (doRefresh) {
          refresh()
        }
      }
    }, 700)


  }

  function addEvents() {
    var els = document.getElementsByClassName("pl")
    console.log('els', els)
    for (var i = 0; i < els.length; i++) {
      var el = els[i]
      el.onclick = function() {
        play(0)
      }
    }

    var els = document.getElementsByClassName("lg-next")
    console.log('els', els)
    for (var i = 0; i < els.length; i++) {
      var el = els[i]
      el.onclick = function() {
        play(1)
      }
    }

    el = document.getElementById("lg-counter")
    console.log('el', el)
    el.onclick = function() {
      play(2)
    }
  }

  $(function() {
    setTimeout(function() {

      addEvents()

    }, 1000)
  })



  document.addEventListener('keydown', function(e){

    if(e.keyCode == 80 ){
      play(1)

      e.preventDefault();
      return false
    }

    if(e.keyCode == 79 ){
      play(0)

      e.preventDefault();
      return false
    }

    if(e.keyCode == 78 ){
      play(2)

      e.preventDefault();
      return false
    }

  })

  </script>
</body>
<html>
